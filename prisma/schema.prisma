// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Clinic {
  id                    String   @id @default(cuid())
  name                  String
  subdomain             String   @unique
  domain                String?
  isActive              Boolean  @default(true)
  maxUsers              Int      @default(10)
  maxPatients           Int      @default(1000)
  maxOffers             Int      @default(5000)
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  subscriptionStatus    String   @default("TRIAL")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  users                 ClinicUser[]
  patients              Patient[]
  offers                Offer[]
  reminders             Reminder[]
  notes                 Note[]
  settings              ClinicSetting[]
  tickets               SupportTicket[]
  offerStatuses         OfferStatus[]

  @@map("clinics")
}

model ClinicUser {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String
  role        String   @default("USER")
  password    String
  isActive    Boolean  @default(true)
  permissions String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  clinicId    String
  clinic      Clinic   @relation(fields: [clinicId], references: [id])

  patients    Patient[]
  offers      Offer[]
  reminders   Reminder[]
  notes       Note[]
  tickets     SupportTicket[]
  messages    SupportMessage[]
  createdTickets SupportTicket[] @relation("TicketCreatedBy")
  assignedTickets SupportTicket[] @relation("TicketAssignedTo")

  @@map("clinic_users")
}

model ClinicSetting {
  id        String   @id @default(cuid())
  key       String
  value     String
  category  String   @default("general")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinicId  String
  clinic    Clinic   @relation(fields: [clinicId], references: [id])

  @@unique([clinicId, key])
  @@map("clinic_settings")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      String   @default("USER")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Patient {
  id                String   @id @default(cuid())
  name              String
  email             String?
  phone             String?
  birthDate         DateTime?
  gender            String?
  address           String?
  city              String?
  country           String   @default("TR")
  nationality       String   @default("TR")
  phoneCountry      String   @default("+90")
  notes             String?
  isActive          Boolean  @default(true)
  isDeleted         Boolean  @default(false)
  referralSourceId  String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  medicalHistory    String?
  allergies         String?
  medications       String?
  emergencyContact  String?

  clinicId          String
  clinic            Clinic   @relation(fields: [clinicId], references: [id])
  
  createdById       String?
  createdBy         ClinicUser? @relation(fields: [createdById], references: [id])

  offers            PatientOffer[]
  reminders         Reminder[]

  referralSource    ReferralSource? @relation(fields: [referralSourceId], references: [id])

  @@map("patients")
}

model OfferStatus {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  color       String   @default("#6B7280")
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  clinicId    String
  clinic      Clinic   @relation(fields: [clinicId], references: [id])

  offers      Offer[]

  @@map("offer_statuses")
}

model Offer {
  id                String   @id @default(cuid())
  title             String
  description       String?
  totalPrice        Float
  currency          String   @default("TRY")
  statusString      String   @default("DRAFT")
  validUntil        DateTime?
  isActive          Boolean  @default(true)
  isDeleted         Boolean  @default(false)
  slug              String   @unique
  pdfTemplateId     String?
  estimatedDuration Int?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  clinicId          String
  clinic            Clinic   @relation(fields: [clinicId], references: [id])
  
  createdById       String?
  createdBy         ClinicUser? @relation(fields: [createdById], references: [id])

  statusId          String?
  status            OfferStatus? @relation(fields: [statusId], references: [id])

  treatments        Treatment[]
  patientOffers     PatientOffer[]
  reminders         Reminder[]

  @@map("offers")
}

model PatientOffer {
  id        String   @id @default(cuid())
  patientId String
  offerId   String
  assigned  Boolean  @default(false)
  visible   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient   Patient  @relation(fields: [patientId], references: [id])
  offer     Offer    @relation(fields: [offerId], references: [id])

  @@unique([patientId, offerId])
  @@map("patient_offers")
}

model Treatment {
  id                String   @id @default(cuid())
  name              String
  description       String?
  price             Float
  currency          String   @default("TRY")
  category          String   @default("general")
  key               String?
  selectedTeeth     String?
  estimatedDuration Int?
  order             Int      @default(0)
  isActive          Boolean  @default(true)
  isDeleted         Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  offerId           String
  offer             Offer    @relation(fields: [offerId], references: [id])

  @@map("treatments")
}

model Note {
  id          String   @id @default(cuid())
  title       String
  content     String
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  clinicId    String
  clinic      Clinic   @relation(fields: [clinicId], references: [id])
  
  userId      String
  user        ClinicUser @relation(fields: [userId], references: [id])

  @@map("notes")
}

model Reminder {
  id          String   @id @default(cuid())
  title       String
  description String?
  dueDate     DateTime
  status      String   @default("PENDING")
  reason      String?
  priorityId  String?
  priority    SupportPriority? @relation(fields: [priorityId], references: [id])
  isPrivate   Boolean  @default(false)
  isPinned    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId    String
  user      ClinicUser   @relation(fields: [userId], references: [id])

  clinicId  String
  clinic    Clinic       @relation(fields: [clinicId], references: [id])

  offerId   String?
  offer     Offer?  @relation(fields: [offerId], references: [id])

  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id])

  @@map("reminders")
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

model ReferralSource {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  description String?
  color       String   @default("#6B7280")
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  patients    Patient[]

  @@map("referral_sources")
}

model SupportCategory {
  id          String   @id @default(cuid())
  name        String
  displayName String
  description String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tickets     SupportTicket[]

  @@map("support_categories")
}

model SupportTicket {
  id          String   @id @default(cuid())
  ticketNumber String  @unique
  title       String
  subject     String?
  description String
  isUrgent    Boolean  @default(false)
  statusId    String?
  status      SupportStatus? @relation(fields: [statusId], references: [id])
  priorityId  String?
  priority    SupportPriority? @relation(fields: [priorityId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categoryId  String
  category    SupportCategory @relation(fields: [categoryId], references: [id])
  
  authorId    String
  author      ClinicUser @relation(fields: [authorId], references: [id])
  
  createdById String?
  createdBy   ClinicUser? @relation("TicketCreatedBy", fields: [createdById], references: [id])
  
  assignedToId String?
  assignedTo   ClinicUser? @relation("TicketAssignedTo", fields: [assignedToId], references: [id])
  
  clinicId    String
  clinic      Clinic @relation(fields: [clinicId], references: [id])

  messages    SupportMessage[]

  @@map("support_tickets")
}

model SupportMessage {
  id          String   @id @default(cuid())
  content     String
  authorName  String?
  authorType  String   @default("USER")
  isFromAdmin Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ticketId    String
  ticket      SupportTicket @relation(fields: [ticketId], references: [id])
  
  authorId    String?
  author      ClinicUser? @relation(fields: [authorId], references: [id])

  @@map("support_messages")
}

model SupportPriority {
  id          String   @id @default(cuid())
  name        String
  displayName String
  level       Int      @default(0)
  color       String   @default("#6B7280")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tickets     SupportTicket[]
  reminders   Reminder[]

  @@map("support_priorities")
}

model SupportStatus {
  id          String   @id @default(cuid())
  name        String
  displayName String
  color       String   @default("#6B7280")
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tickets     SupportTicket[]

  @@map("support_statuses")
} 